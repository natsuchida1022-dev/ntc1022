<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>観察型MBTI診断｜0–2歳 / 3–5歳</title>

<!-- （任意）フォント -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#fffaf4; --ink:#1f2a37; --muted:#5b6472;
    --card:#ffffff; --border:#f0f2f5; --shadow:0 6px 20px rgba(31,42,55,.08);
    --btn:#1f2a37; --btn-ink:#fff; --progress:#8b5cf6;
    --pill:#f7fafc; --pill-border:#e6eef7;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--ink);background:
      radial-gradient(1200px 1200px at 10% -10%, #fff1e6 0%, rgba(255,241,230,0) 60%),
      radial-gradient(1200px 1200px at 110% 10%, #e7f8ff 0%, rgba(231,248,255,0) 60%),
      var(--bg);
    font-family:"Noto Sans JP", system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif;
  }
  .wrap{max-width:880px;margin:0 auto;padding:18px}
  header{padding:6px 0 10px}
  h1{margin:0 0 8px;font-size:1.5rem;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:.96rem}
  .tabs{display:flex;gap:10px;margin:12px 0}
  .tab{border:1px solid var(--border); background:#fff; border-radius:999px; padding:8px 14px; cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,.04); font-weight:700; font-size:.95rem; color:#445;}
  .tab.active{background:#1f2a37;color:#fff;border-color:#1f2a37}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;background:var(--pill);border:1px solid var(--pill-border);font-size:.82rem;color:#3d4854}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .progress{height:12px;border-radius:999px;background:#eff3f7;overflow:hidden;border:1px solid #e8edf3}
  .bar{height:100%;width:0;background:var(--progress);transition:width .25s ease}
  .qno{color:var(--muted);font-size:.92rem}
  .question{font-size:1.12rem;margin:8px 0 14px;line-height:1.55}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .btn{width:100%;padding:14px 16px;border-radius:14px;border:1px solid #e6ebf1;background:#fff;
    font-size:1.06rem;line-height:1.4;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .btn:hover{filter:brightness(0.98)} .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--btn);color:var(--btn-ink);border-color:var(--btn)}
  .cta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
  .hint{background:#f9fbff;border:1px solid #e6f0ff;border-radius:14px;padding:12px}
  .small{font-size:.9rem;color:var(--muted)}
  .result-type{font-size:1.7rem;margin:8px 0}
  .type-pill{display:inline-block;border-radius:12px;padding:6px 10px;background:#eef6ff;border:1px solid #d9ecff;font-weight:700}
  .grid{display:grid;gap:10px}
  @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  footer{margin:18px 0 8px;color:var(--muted);font-size:.85rem}
  .ghost{opacity:.55}

  /* 出題中カテゴリ色 */
  .theme-ei{--progress:#ff9f6e; --btn:#ff7a3d}
  .theme-sn{--progress:#5dd4c6; --btn:#28bdb0}
  .theme-ft{--progress:#ff88b5; --btn:#ff5a94}
  .theme-jp{--progress:#7ea6ff; --btn:#4b82ff}

  /* 結果ページテーマ（分析家/番人/外交官/探検家） */
  #page-result.theme-analyst  { --accent:#8b5cf6; --accent-bg:#f3efff; --accent-br:#e3dbff; } /* 薄紫 */
  #page-result.theme-sentinel { --accent:#4b82ff; --accent-bg:#eef5ff; --accent-br:#dbe8ff; } /* 水色 */
  #page-result.theme-diplomat { --accent:#28bdb0; --accent-bg:#e9fbf8; --accent-br:#c8f1ec; } /* 薄緑 */
  #page-result.theme-explorer { --accent:#f6b63a; --accent-bg:#fff7e6; --accent-br:#ffe7b3; } /* 黄色 */

  #page-result[class*="theme-"] .type-pill{
    background: var(--accent-bg);
    border-color: var(--accent-br);
    color: var(--accent);
  }
  #page-result[class*="theme-"] .hint{
    background: var(--accent-bg);
    border-color: var(--accent-br);
  }
  #page-result[class*="theme-"] .btn.primary{
    background: var(--accent);
    border-color: var(--accent);
    color:#fff;
  }
  #page-result[class*="theme-"] .result-type::after{
    content:""; display:block; height:4px; border-radius:999px; margin-top:6px;
    background: var(--accent);
  }

  /* 診断結果の軸バー（日本語ラベル＋中央線） */
  .axes{display:grid;gap:10px;margin:10px 0}
  .axis-row{display:grid;grid-template-columns:90px 1fr 90px;align-items:center;gap:10px}
  .axis-left,.axis-right{font-size:.92rem;color:var(--muted);text-align:center;white-space:nowrap}
  .axis-wrap{position:relative;height:16px;border-radius:999px;background:#eff3f7;border:1px solid #e8edf3;overflow:hidden}
  .axis-fillL,.axis-fillR{position:absolute;top:0;height:100%}
  .axis-fillL{left:0;border-right:1px solid rgba(31,42,55,.05)}
  .axis-fillR{right:0;border-left:1px solid rgba(31,42,55,.05)}
  .axis-mid{position:absolute;left:50%;top:-4px;bottom:-4px;width:2px;background:#e5eaf0;opacity:.9}

  .axis-EI .axis-fillL{background:#ffd2be}  /* 外向(左) */
  .axis-EI .axis-fillR{background:#d7e3ff}  /* 内向(右) */
  .axis-SN .axis-fillL{background:#c9f3ee}  /* 感覚(左) */
  .axis-SN .axis-fillR{background:#f2e9ff}  /* 直観(右) */
  .axis-FT .axis-fillL{background:#ffd6e7}  /* 感情(左) */
  .axis-FT .axis-fillR{background:#ffe9ef}  /* 思考(右) */
  .axis-JP .axis-fillL{background:#dbe7ff}  /* 計画(左) */
  .axis-JP .axis-fillR{background:#fff0c9}  /* 柔軟(右) */

  /* 今回はタイプ画像を使わないので非表示 */
  .result-visual img{display:none}
  /* 共有テキスト用の旧スコア出力は画面に出さない */
  .sr-scores{display:none}
/* ===== バーをくっきり（色・コントラストUP） ===== */
.axis-wrap{
  position:relative;height:16px;border-radius:999px;
  background:#e8edf5;             /* 土台を少し濃いグレーに */
  border:1px solid #dfe6ef;
  overflow:hidden;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.6),
              inset 0 0 0 1px rgba(0,0,0,.04);
}
.axis-fillL,.axis-fillR{
  position:absolute;top:0;height:100%;
  transition:width .28s ease;      /* 伸びのアニメを滑らかに */
}

/* 色を濃く・鮮やかに */
.axis-EI .axis-fillL{background:#ff9a6a}  /* 外向：濃いオレンジ */
.axis-EI .axis-fillR{background:#8cb0ff}  /* 内向：はっきりブルー */

.axis-SN .axis-fillL{background:#38d6c7}  /* 感覚：ビビッドミント */
.axis-SN .axis-fillR{background:#b8a5ff}  /* 直観：明るいパープル */

.axis-FT .axis-fillL{background:#ff83b5}  /* 感情：鮮やかピンク */
.axis-FT .axis-fillR{background:#ffb3c4}  /* 思考：コーラル系ピンク */

.axis-JP .axis-fillL{background:#7ea6ff}  /* 計画：はっきりブルー */
.axis-JP .axis-fillR{background:#ffd06a}  /* 柔軟：濃いめイエロー */
/* 結果画像は必ず表示できる状態に（他の指定を上書き） */
.result-visual img{
  display:block !important;
  width:140px;height:140px;object-fit:contain;
  border-radius:12px;border:1px solid #e6eef7;background:#fff;
}
/* --- 結果画像をくっきり表示（ビビッド化） --- */
.result-visual img{
  opacity: 1 !important;            /* 透過の継承を遮断 */
  mix-blend-mode: normal !important; /* ブレンド無効化 */
  filter: saturate(1.35) contrast(1.1) brightness(1.03); /* 彩度/コントラストUP */
  background: #fff;                  /* 画像の下地を白で固定 */
  border: 1px solid #dfe7f2;         /* 輪郭をほんのり強調 */
  box-shadow: 0 2px 8px rgba(0,0,0,.05); /* ふわっと見やすく */
}
/* 画像の色味・ブレンドを完全無効化（最優先） */
.result-visual img{
  filter: none !important;            /* どんなフィルターも打ち消す */
  mix-blend-mode: normal !important;  /* 背景との掛け合わせ無効 */
  opacity: 1 !important;              /* 透過を打ち消す */
  background: #fff;                   /* 下地は白で固定 */
  border: 1px solid #e3eaf3;          /* うっすら枠で見やすく */
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
}
/* 画像の色味を一切いじらない・掛け合わせもしない */
#typeImgFrame{ background:#fff !important; }          /* 下地は真っ白に固定 */
.result-visual img{
  filter: none !important;                              /* 既存のフィルターを無効化 */
  mix-blend-mode: normal !important;                    /* ブレンド無効化 */
  opacity: 1 !important;                                /* 透過を無効化 */
}

</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>観察型MBTI診断｜0–2歳 / 3–5歳</h1>
    <div class="sub">年齢に合わせた観察質問40問でタイプを自動判定（EI / SN / FT / JP）</div>
    <div class="tabs">
      <button id="tab02" class="tab active">0–2歳</button>
      <button id="tab35" class="tab">3–5歳</button>
    </div>
  </header>

  <!-- TOP -->
  <section id="page-top" class="card">
    <div class="badges">
      <span class="pill" id="ageBadge">対象：0–2歳</span>
      <span class="pill">スマホOK</span>
      <span class="pill">自動判定</span>
    </div>
    <p class="small" style="margin-top:6px">カテゴリごとに色が変わるから直感的！</p>
    <div class="cta">
      <button class="btn primary" id="startBtn">診断をはじめる</button>
      <button class="btn" id="resumeBtn" title="前回の続きがある場合のみ有効">前回の続きから</button>
    </div>
  </section>

  <!-- 質問 -->
  <section id="page-quiz" class="card theme-ei" style="display:none">
    <div class="qno" id="qIndex">質問 1 / 40</div>
    <div class="badges">
      <span class="pill" id="badgeCat">E / I</span>
      <span class="pill" id="badgeScene">場面</span>
      <span class="pill" id="badgeAge">0–2歳</span>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="question" id="qText">ここに質問</div>
    <div class="row">
      <button class="btn col" id="btnA">A</button>
      <button class="btn col" id="btnB">B</button>
    </div>
    <div class="cta">
      <button class="btn" id="backBtn">◀ 戻る</button>
      <button class="btn primary" id="skipBtn">スキップ</button>
    </div>
  </section>

  <!-- 結果 -->
  <section id="page-result" class="card" style="display:none">
    <div class="qno">診断結果（<span id="ageLabelResult">0–2歳</span>）</div>
    <div class="result-type"><span class="type-pill" id="type4"></span></div>

    <!-- タイプ概要 -->
    <div class="result-visual">
      <img id="typeImg" alt="タイプ画像" />
      <div>
        <div id="typeName" style="font-weight:700;margin:4px 0 6px"></div>
        <div id="typeOneLiner" class="small" style="margin-bottom:10px"></div>
      </div>
    </div>

    <!-- 日本語ラベル＋バー -->
    <div id="axes" class="axes" style="margin-bottom:6px">
      <div class="axis-row axis-EI">
        <div class="axis-left">外向</div>
        <div class="axis-wrap">
          <span class="axis-fillL"></span>
          <span class="axis-fillR"></span>
          <span class="axis-mid"></span>
        </div>
        <div class="axis-right">内向</div>
      </div>
      <div class="axis-row axis-SN">
        <div class="axis-left">感覚</div>
        <div class="axis-wrap">
          <span class="axis-fillL"></span>
          <span class="axis-fillR"></span>
          <span class="axis-mid"></span>
        </div>
        <div class="axis-right">直観</div>
      </div>
      <div class="axis-row axis-FT">
        <div class="axis-left">感情</div>
        <div class="axis-wrap">
          <span class="axis-fillL"></span>
          <span class="axis-fillR"></span>
          <span class="axis-mid"></span>
        </div>
        <div class="axis-right">思考</div>
      </div>
      <div class="axis-row axis-JP">
        <div class="axis-left">計画</div>
        <div class="axis-wrap">
          <span class="axis-fillL"></span>
          <span class="axis-fillR"></span>
          <span class="axis-mid"></span>
        </div>
        <div class="axis-right">柔軟</div>
      </div>
    </div>

    <!-- 共有文面用に数値も裏で保持（画面には出さない） -->
    <div class="sr-scores" aria-hidden="true">
      <span id="scoreEI"></span>
      <span id="scoreSN"></span>
      <span id="scoreFT"></span>
      <span id="scoreJP"></span>
    </div>

    <div class="hint" id="hintBox">
      <div style="font-weight:700;margin-bottom:6px">関わりのヒント</div>
      <div id="typeHint"></div>
    </div>

    <!-- シェア -->
    <div class="cta share-buttons">
      <button class="btn" id="btnShare">共有する（端末の共有メニュー）</button>
      <button class="btn" id="btnCopy">テキストをコピー</button>
      <button class="btn" id="btnSaveImg">画像を保存（PNG）</button>
    </div>

    <div class="cta" style="margin-top:4px">
      <button class="btn" id="retryBtn">もう一度診断する</button>
      <button class="btn" id="seeAllBtn">他タイプの解説を見る</button>
    </div>

    <div class="small" style="margin-top:12px">
      ※ 子どもの性格はまだ成長の途中。タイプは変化することも。今の“らしさ”を知るヒントとして、やさしく見守っていきましょう🌱
    </div>
  </section>

  <!-- 16タイプ解説 -->
  <section id="page-all" class="card" style="display:none">
    <div class="qno">16タイプ解説（保護者・保育者向け）</div>
    <div id="typesGrid" class="grid"></div>
    <div class="cta">
      <button class="btn" id="backHomeBtn">トップへ戻る</button>
    </div>
  </section>

  <footer>© 観察型MBTI</footer>
</div>

<script>
/* 画像は使わない */
const TYPE_IMG = {};

/* ====== 年齢別の質問セット（省略なし） ====== */
/* 0–2歳 */
const QUESTIONS_02 = [
  /* EI */
  {cat:'EI', scene:'園庭に出た直後', q:'A：すぐに周りへ歩いて行く（E） / B：しばらく大人のそばで様子を見る（I）', Ais:'E', Bis:'I', A:'すぐ歩いて行く（E）', B:'そばで様子を見る（I）'},
  {cat:'EI', scene:'初めて会う大人', q:'A：自分から近づき笑顔（E） / B：肩越しにじっと見る（I）', Ais:'E', Bis:'I', A:'近づき笑顔（E）', B:'肩越しに観察（I）'},
  {cat:'EI', scene:'にぎやかな部屋', q:'A：音や声に弾む反応（E） / B：音の方を静かに観察（I）', Ais:'E', Bis:'I', A:'弾む反応（E）', B:'静かに観察（I）'},
  {cat:'EI', scene:'他児が笑っている', q:'A：すぐにつられて笑う（E） / B：表情を見てから微笑む（I）', Ais:'E', Bis:'I', A:'つられて笑う（E）', B:'様子見て微笑む（I）'},
  {cat:'EI', scene:'おもちゃ発見', q:'A：誰かに見せに行く（E） / B：黙々と触って確かめる（I）', Ais:'E', Bis:'I', A:'見せに行く（E）', B:'黙々と確かめる（I）'},
  {cat:'EI', scene:'名前を呼ばれる', q:'A：すぐ振り向き近づく（E） / B：一拍おき視線だけ向ける（I）', Ais:'E', Bis:'I', A:'すぐ近づく（E）', B:'視線だけ向ける（I）'},
  {cat:'EI', scene:'新しい場所', q:'A：範囲を広げ探索（E） / B：小さな範囲でゆっくり確認（I）', Ais:'E', Bis:'I', A:'広く探索（E）', B:'小さく確認（I）'},
  {cat:'EI', scene:'注目された時', q:'A：得意そうに反応が増える（E） / B：視線を外す・体を引く（I）', Ais:'E', Bis:'I', A:'反応が増える（E）', B:'視線外す/引く（I）'},
  {cat:'EI', scene:'知らない子が接近', q:'A：前へ向け関わる（E） / B：後ろへ引き距離をとる（I）', Ais:'E', Bis:'I', A:'前向き関わる（E）', B:'距離をとる（I）'},
  {cat:'EI', scene:'お迎えの人が増えた', q:'A：人から人へ移り関わる（E） / B：安心できる大人に張りつく（I）', Ais:'E', Bis:'I', A:'次々関わる（E）', B:'安心な大人へ（I）'},

  /* SN */
  {cat:'SN', scene:'積み木', q:'A：同じ形をまっすぐ積む（S） / B：動物や車に見立てて並べる（N）', Ais:'S', Bis:'N', A:'まっすぐ積む（S）', B:'見立てて並べる（N）'},
  {cat:'SN', scene:'絵本', q:'A：絵の物を指さし確認（S） / B：場面のごっこ声や表情を作る（N）', Ais:'S', Bis:'N', A:'指さし確認（S）', B:'表情・声でごっこ（N）'},
  {cat:'SN', scene:'コップとスプーン', q:'A：実物どおりに使う（S） / B：電話・ドラムなど別物に見立て（N）', Ais:'S', Bis:'N', A:'実物どおり（S）', B:'別物に見立て（N）'},
  {cat:'SN', scene:'いないいないばあ', q:'A：同じタイミングで毎回大喜び（S） / B：タイミング変えるとより反応（N）', Ais:'S', Bis:'N', A:'同じで喜ぶ（S）', B:'変化で喜ぶ（N）'},
  {cat:'SN', scene:'道で車が通る', q:'A：音や色・大きさに注目（S） / B：運転や行き先を真似して遊ぶ（N）', Ais:'S', Bis:'N', A:'音や色へ注目（S）', B:'運転ごっこ（N）'},
  {cat:'SN', scene:'ブロックの色', q:'A：色や形の違いにすぐ気づく（S） / B：色をキャラに当て物語にする（N）', Ais:'S', Bis:'N', A:'違いに気づく（S）', B:'色で物語（N）'},
  {cat:'SN', scene:'クレヨン', q:'A：線・点を繰り返す（S） / B：「雨」「くるま」など意味づけ（N）', Ais:'S', Bis:'N', A:'線・点を反復（S）', B:'意味づけ描く（N）'},
  {cat:'SN', scene:'音のなるおもちゃ', q:'A：押す→鳴るの因果を楽しむ（S） / B：音に合わせ踊る・場面を作る（N）', Ais:'S', Bis:'N', A:'因果を楽しむ（S）', B:'音で場面づくり（N）'},
  {cat:'SN', scene:'おままごと', q:'A：見た手順をそのまま再現（S） / B：空の皿でも「食べるふり」を広げる（N）', Ais:'S', Bis:'N', A:'手順を再現（S）', B:'ふりで広げる（N）'},
  {cat:'SN', scene:'新しいおもちゃ', q:'A：まず触って確かめる（S） / B：触る前に使い方を想像し試す（N）', Ais:'S', Bis:'N', A:'触って確かめる（S）', B:'想像して試す（N）'},

  /* FT */
  {cat:'FT', scene:'近くで泣き声', q:'A：顔を曇らせ近づく・なでる（F） / B：周りを見回し大人の方を見る（T）', Ais:'F', Bis:'T', A:'寄り添い近づく（F）', B:'大人へサイン（T）'},
  {cat:'FT', scene:'取り合い', q:'A：相手の様子を気にして引く（F） / B：元の持ち主や順番を確認（T）', Ais:'F', Bis:'T', A:'相手を気にする（F）', B:'順番を確認（T）'},
  {cat:'FT', scene:'注意された', q:'A：しょんぼり・抱っこを求める（F） / B：一瞬停止して行動を変える（T）', Ais:'F', Bis:'T', A:'しょんぼり寄る（F）', B:'行動を変える（T）'},
  {cat:'FT', scene:'誰かが転んだ', q:'A：覗き込みそばに座る（F） / B：ティッシュを取る・大人を指さす（T）', Ais:'F', Bis:'T', A:'そばに座る（F）', B:'対処へ動く（T）'},
  {cat:'FT', scene:'大人の声色が変わる', q:'A：表情が影響されやすい（F） / B：指示の内容に反応（T）', Ais:'F', Bis:'T', A:'声色に影響（F）', B:'内容に反応（T）'},
  {cat:'FT', scene:'ごっこ遊び', q:'A：「よしよし」「どうしたの？」が多い（F） / B：「こうやる」「次はこれ」が多い（T）', Ais:'F', Bis:'T', A:'よしよし多い（F）', B:'手順多い（T）'},
  {cat:'FT', scene:'笑いが起きた', q:'A：一緒に笑い共有を優先（F） / B：何が起きたか確かめる（T）', Ais:'F', Bis:'T', A:'共有して笑う（F）', B:'理由を確かめる（T）'},
  {cat:'FT', scene:'順番待ち', q:'A：「待つのたいへんだね」風の寄り添い（F） / B：順番の合図や秩序に注目（T）', Ais:'F', Bis:'T', A:'気持ちに寄り添う（F）', B:'秩序に注目（T）'},
  {cat:'FT', scene:'玩具が壊れた', q:'A：困った表情で慰めを求める（F） / B：原因を見て直そうとする（T）', Ais:'F', Bis:'T', A:'慰め求める（F）', B:'直そうとする（T）'},
  {cat:'FT', scene:'ケンカのあと', q:'A：なでる・抱きつく等の仲直り行動（F） / B：原因やきっかけを指さし確認（T）', Ais:'F', Bis:'T', A:'仲直り行動（F）', B:'原因を確認（T）'},

  /* JP */
  {cat:'JP', scene:'おやつ前', q:'A：呼ばれる前から席へ向かう（J） / B：声かけで気づき席へ（P）', Ais:'J', Bis:'P', A:'自分で席へ（J）', B:'声かけで席へ（P）'},
  {cat:'JP', scene:'いつもの支度', q:'A：決まった順番で進める（J） / B：気になった物から手を出す（P）', Ais:'J', Bis:'P', A:'順番で進める（J）', B:'気になった物から（P）'},
  {cat:'JP', scene:'遊びの切り替え', q:'A：「おしまい」の合図で片づけ（J） / B：「もう一回！」が続きやすい（P）', Ais:'J', Bis:'P', A:'合図で片づけ（J）', B:'もう一回続く（P）'},
  {cat:'JP', scene:'置き場所', q:'A：元の場所へ戻す（J） / B：近くにポンと置きがち（P）', Ais:'J', Bis:'P', A:'元の場所へ（J）', B:'近くに置く（P）'},
  {cat:'JP', scene:'予定変更', q:'A：不安げ・予告で落ち着く（J） / B：すぐ新しい方へ乗り換える（P）', Ais:'J', Bis:'P', A:'予告で安心（J）', B:'すぐ乗り換え（P）'},
  {cat:'JP', scene:'活動中の視線', q:'A：次の展開をちらちら確認（J） / B：目の前に夢中で続ける（P）', Ais:'J', Bis:'P', A:'次を確認（J）', B:'目の前に夢中（P）'},
  {cat:'JP', scene:'片づけ指示', q:'A：区切って順に進めるとスムーズ（J） / B：合図より面白さで動く（P）', Ais:'J', Bis:'P', A:'区切ると進む（J）', B:'面白さ優先（P）'},
  {cat:'JP', scene:'新しい遊び', q:'A：やり方を見てから取り組む（J） / B：触りながら覚える（P）', Ais:'J', Bis:'P', A:'見てから（J）', B:'触りながら（P）'},
  {cat:'JP', scene:'朝の流れ', q:'A：決まったルーティンで安心（J） / B：その日の気分で変わる（P）', Ais:'J', Bis:'P', A:'ルーティン安心（J）', B:'気分で変わる（P）'},
  {cat:'JP', scene:'保育室の出入り', q:'A：靴・荷物の順番が整うと動きやすい（J） / B：気づいた順に動き出す（P）', Ais:'J', Bis:'P', A:'整うと動ける（J）', B:'気づいた順に動く（P）'}
];

/* 3–5歳 */
const QUESTIONS_35 = [
  /* EI */
  {cat:'EI', scene:'登園してすぐ', q:'A：友だちに自分から声をかける（E） / B：ロッカー周りで静かに準備（I）', Ais:'E', Bis:'I', A:'自分から声かけ（E）', B:'静かに準備（I）'},
  {cat:'EI', scene:'自由遊びの始まり', q:'A：誰が遊んでるか見つけて混ざる（E） / B：一人遊びを続けて様子を見る（I）', Ais:'E', Bis:'I', A:'混ざる（E）', B:'一人で様子見（I）'},
  {cat:'EI', scene:'初めての先生', q:'A：自己紹介や質問をする（E） / B：にこっとして距離を保つ（I）', Ais:'E', Bis:'I', A:'質問・自己紹介（E）', B:'にこっと距離（I）'},
  {cat:'EI', scene:'集団遊びの誘い', q:'A：すぐ入りたがる（E） / B：しばらく見学してから入る（I）', Ais:'E', Bis:'I', A:'すぐ入る（E）', B:'見学してから（I）'},
  {cat:'EI', scene:'作品の発表', q:'A：見て見て！と見せて回る（E） / B：必要なときだけ見せる（I）', Ais:'E', Bis:'I', A:'見せて回る（E）', B:'必要時のみ（I）'},
  {cat:'EI', scene:'騒がしい部屋', q:'A：テンションが上がる（E） / B：静かな隅に移動したがる（I）', Ais:'E', Bis:'I', A:'上がる（E）', B:'隅へ（I）'},
  {cat:'EI', scene:'園庭の新遊具', q:'A：最初に試したがる（E） / B：他の子の様子を見てから（I）', Ais:'E', Bis:'I', A:'先に試す（E）', B:'様子を見て（I）'},
  {cat:'EI', scene:'初めてのグループ', q:'A：役割を決めたがる（E） / B：言われた役を受ける（I）', Ais:'E', Bis:'I', A:'役を決める（E）', B:'受ける（I）'},
  {cat:'EI', scene:'お迎え時', q:'A：その日あった事をたくさん話す（E） / B：聞かれてから短く話す（I）', Ais:'E', Bis:'I', A:'たくさん話す（E）', B:'聞かれて話す（I）'},
  {cat:'EI', scene:'写真撮影', q:'A：前に出てポーズ（E） / B：後ろの方で控えめ（I）', Ais:'E', Bis:'I', A:'前でポーズ（E）', B:'控えめ（I）'},

  /* SN */
  {cat:'SN', scene:'積み木やブロック', q:'A：安定した形を作る（S） / B：見立てで物語を作る（N）', Ais:'S', Bis:'N', A:'安定重視（S）', B:'物語重視（N）'},
  {cat:'SN', scene:'お絵かき', q:'A：見たものをそのまま描く（S） / B：空想の生き物や世界を描く（N）', Ais:'S', Bis:'N', A:'見たまま（S）', B:'空想世界（N）'},
  {cat:'SN', scene:'工作', q:'A：手順通りに作る（S） / B：材料の使い方を工夫する（N）', Ais:'S', Bis:'N', A:'手順通り（S）', B:'工夫する（N）'},
  {cat:'SN', scene:'読み聞かせ', q:'A：絵の細部に注目（S） / B：先の展開を予想（N）', Ais:'S', Bis:'N', A:'細部に注目（S）', B:'展開を予想（N）'},
  {cat:'SN', scene:'ごっこ遊び', q:'A：現実に近い設定が多い（S） / B：魔法・宇宙など非現実設定（N）', Ais:'S', Bis:'N', A:'現実寄り（S）', B:'非現実（N）'},
  {cat:'SN', scene:'散歩', q:'A：標識・色・数をよく見る（S） / B：もし〜だったら…を話す（N）', Ais:'S', Bis:'N', A:'細かい特徴（S）', B:'もし○○なら（N）'},
  {cat:'SN', scene:'ブロックの不安定さ', q:'A：崩れないよう調整（S） / B：崩れるのも面白いと試す（N）', Ais:'S', Bis:'N', A:'崩れない調整（S）', B:'試行する（N）'},
  {cat:'SN', scene:'パズル', q:'A：ピース形状から合わせる（S） / B：絵のストーリーから合わせる（N）', Ais:'S', Bis:'N', A:'形重視（S）', B:'ストーリー重視（N）'},
  {cat:'SN', scene:'絵カード', q:'A：現実の名前当てが得意（S） / B：ありえない組合せを楽しむ（N）', Ais:'S', Bis:'N', A:'名前当て（S）', B:'ヘンテコOK（N）'},
  {cat:'SN', scene:'新しい遊び', q:'A：見本を見て真似る（S） / B：自分ルールを作る（N）', Ais:'S', Bis:'N', A:'見本通り（S）', B:'自分ルール（N）'},

  /* FT */
  {cat:'FT', scene:'友だちが泣く', q:'A：背中をなでる・ティッシュを渡す（F） / B：先生に状況を伝える（T）', Ais:'F', Bis:'T', A:'寄り添い・渡す（F）', B:'状況を報告（T）'},
  {cat:'FT', scene:'順番で「ぼくが先！」', q:'A：「待つのたいへんだよね」と共感（F） / B：「さっき○○ちゃんが先だよ」と伝える（T）', Ais:'F', Bis:'T', A:'共感する（F）', B:'順番を伝える（T）'},
  {cat:'FT', scene:'ルール違反を見た', q:'A：ケンカにならないような声かけ（F） / B：ルールをはっきり指摘（T）', Ais:'F', Bis:'T', A:'なだめる（F）', B:'指摘する（T）'},
  {cat:'FT', scene:'共同制作', q:'A：友だちの意見を優先（F） / B：完成のために役割分担（T）', Ais:'F', Bis:'T', A:'意見優先（F）', B:'役割分担（T）'},
  {cat:'FT', scene:'叱られたあと', q:'A：しょんぼり→慰めを求める（F） / B：理由を理解して次へ（T）', Ais:'F', Bis:'T', A:'慰めを求める（F）', B:'切替える（T）'},
  {cat:'FT', scene:'対立が起きた', q:'A：気持ちを代弁する（F） / B：順番やルールで収める（T）', Ais:'F', Bis:'T', A:'気持ち代弁（F）', B:'ルールで収める（T）'},
  {cat:'FT', scene:'失敗した友だち', q:'A：「大丈夫だよ」と励ます（F） / B：「こうするといいよ」と提案（T）', Ais:'F', Bis:'T', A:'励ます（F）', B:'提案する（T）'},
  {cat:'FT', scene:'笑いが起きた', q:'A：一緒に笑いを共有（F） / B：何が面白かったか分析（T）', Ais:'F', Bis:'T', A:'共有（F）', B:'分析（T）'},
  {cat:'FT', scene:'片づけ忘れ', q:'A：「先生が困っちゃうね」と気持ちに結ぶ（F） / B：「片づけないと次できないよ」と理由（T）', Ais:'F', Bis:'T', A:'気持ちに結ぶ（F）', B:'理由で促す（T）'},
  {cat:'FT', scene:'友だちの失敗談', q:'A：気持ちに寄り添って聞く（F） / B：改善点を一緒に考える（T）', Ais:'F', Bis:'T', A:'寄り添う（F）', B:'改善考える（T）'},

  /* JP */
  {cat:'JP', scene:'朝のルーティン', q:'A：決まった順で支度が進む（J） / B：その日の気分で変わる（P）', Ais:'J', Bis:'P', A:'順に進む（J）', B:'気分で変わる（P）'},
  {cat:'JP', scene:'活動の切替', q:'A：合図でスッと切替（J） / B：続きが気になりがち（P）', Ais:'J', Bis:'P', A:'合図で切替（J）', B:'続きが気になる（P）'},
  {cat:'JP', scene:'制作の手順', q:'A：説明を聞いてから取り組む（J） / B：やりながら覚える（P）', Ais:'J', Bis:'P', A:'説明→実行（J）', B:'やりながら（P）'},
  {cat:'JP', scene:'予定変更', q:'A：事前予告で安心（J） / B：変更でもすぐ楽しめる（P）', Ais:'J', Bis:'P', A:'予告で安心（J）', B:'変更OK（P）'},
  {cat:'JP', scene:'片づけ', q:'A：区切って順序立てると捗る（J） / B：面白い物に寄り道（P）', Ais:'J', Bis:'P', A:'順序で捗る（J）', B:'寄り道（P）'},
  {cat:'JP', scene:'順番待ち', q:'A：並ぶ位置や順を気にする（J） / B：列から離れて別の遊びも（P）', Ais:'J', Bis:'P', A:'順を気にする（J）', B:'別の遊びへ（P）'},
  {cat:'JP', scene:'連絡や見通し', q:'A：先に知ると落ち着く（J） / B：知らなくても平気（P）', Ais:'J', Bis:'P', A:'先に知ると安心（J）', B:'平気（P）'},
  {cat:'JP', scene:'ゲームのルール', q:'A：ルール通りが楽しい（J） / B：ルールをアレンジ（P）', Ais:'J', Bis:'P', A:'通りが楽しい（J）', B:'アレンジ（P）'},
  {cat:'JP', scene:'製作の片づけ時刻', q:'A：時間を意識して終わらせる（J） / B：時間超過もしばしば（P）', Ais:'J', Bis:'P', A:'時間意識（J）', B:'超過しがち（P）'},
  {cat:'JP', scene:'遠足の準備', q:'A：前日から準備したがる（J） / B：当日気分で準備（P）', Ais:'J', Bis:'P', A:'前日準備（J）', B:'当日準備（P）'}
];

/* 16タイプ解説（ヒントを長文化） */
const TYPE_TEXT = {
  ENFP:{name:'わくわく好奇心タイプ', one:'「やってみたい！」の芽がいっぱい。', hint:'好奇心の芽を摘まず、まず共感。「やってみたい」を一緒に形に。危険は環境側で調整し、安全の枠だけ示す。結果より挑戦を褒め、選べる余白と小さな成功を毎日用意。'},
  ENFJ:{name:'思いやりリーダータイプ', one:'周りを笑顔にするやさしさ。', hint:'人の気持ちに敏感。頑張り役になりすぎないよう、助ける前に「今は自分の気持ちはどう？」と立ち止まる合図を。役割は交代制にし、感謝を言葉で返し自己肯定感を育てる。'},
  INFJ:{name:'心で寄りそうタイプ', one:'静かに人の気持ちを感じ取る繊細さん。', hint:'静かな共感力を守るため、刺激は穏やかに。予定や見通しを先に伝え、安心基地（抱っこや席）を確保。気持ちは急かさず受け止め、少人数や一対一でゆっくり関わる時間を増やす。'},
  INFP:{name:'夢見がちな思いやりタイプ', one:'マイペースで空想も大好き。', hint:'空想や好きに没頭できる時間を毎日少し。否定語より共感語で橋渡しし、困りごとは選択肢から自分で選べるよう支援。間違いを責めず、作品や思いつきを丁寧に扱って心を守る。'},
  ENTP:{name:'アイデア発明タイプ', one:'触って確かめる、ひらめきの天才。', hint:'試すことで学ぶタイプ。禁止より安全な試し方を一緒に発明しよう。「どうしたら安全にできる？」と問いかけ、結果の善し悪しより仮説と工夫を称賛。道具や素材は自由度高めに。'},
  ENTJ:{name:'行動リーダータイプ', one:'「こうしたい！」がはっきり、行動も早い。', hint:'意思がはっきり。命令になりすぎないよう選べる指示にし、目的→手順→完了を簡潔に示すと安心。計画が崩れた時は代替案を用意し、待つ力が要る場面は予告と時間見通しで支える。'},
  INTJ:{name:'静かなる計画タイプ', one:'じっくり観察する小さな戦略家。', hint:'観察と計画が得意。まず見て考える時間を確保し、口出しは最小限に。やり方は図や順番で示し、目的を共有すると自走しやすい。変更は早めに知らせ、静かな環境で集中を守る。'},
  INTP:{name:'考える研究タイプ', one:'物の仕組みに興味津々。', hint:'仕組みへの好奇心を尊重。分解・検証の余白を作り、失敗はデータとして歓迎。「なぜ？」に一緒に向き合い、説明は原理から短く。話しかけ過多を避け、集中が切れたら休憩を挟む。'},
  ESFP:{name:'ごきげんムードメーカー', one:'明るくノリよく、みんなを笑顔に。', hint:'体験で吸収するタイプ。共に笑い、体を使う活動を多めに。注意は短く肯定形で伝え、成功をその場ですぐ褒める。切り替えは次の楽しみを提示し、写真や作品で楽しかった記憶を残す。'},
  ESTP:{name:'やってみたいチャレンジャー', one:'体で覚えるスピード派。', hint:'挑戦心を安全に活かす。禁止で止めるより、危険の見える化と安全ルールを先に練習。短い説明→すぐ実践が効果的。道具は本物に近いものを用い、成功・失敗の振り返りを一緒に。'},
  ISFP:{name:'やさしい感性タイプ', one:'穏やかで感受性豊か。', hint:'感受性を守る静かな関わりを。急がせず、触感や色など心地よい素材を用意。言葉が出にくい時は選択肢カードで意思を尊重。評価より共感の言葉を多く、安心できる人との時間を確保。'},
  ISFJ:{name:'おだやかサポートタイプ', one:'空気を感じ取る思いやりの子。', hint:'気配り上手。周囲を優先しすぎないよう、お願いと断る練習を小さく積む。予告とルーティンで安心を作り、役に立てた場面は言葉で承認。新しいことは見本→一緒に→自分での順に。'},
  ESTJ:{name:'きっちり安心タイプ', one:'順番・ルールで落ち着く。', hint:'秩序が安心の土台。ルールや手順は視覚化し、守れた点を具体的に称える。予定変更は早めに伝え、選べる代案を提示。頑張りすぎを防ぐため、休憩や自由時間もスケジュールに。'},
  ESFJ:{name:'お世話好きタイプ', one:'みんなと一緒がうれしい。', hint:'みんなと一緒が力。役割を任せて感謝を言葉で返すと輝く。対立時は気持ちの言語化を手伝い、全員が納得する落とし所を一緒に探す。一対一の甘え時間も確保して心を満たす。'},
  ISTJ:{name:'ていねい整理タイプ', one:'決まった順番ときっちりが好き。', hint:'見通しと順序で安心。場所や物の定位置を決め、手順はカードで可視化。突然の変更は小さな予告を重ねて橋渡し。丁寧さを評価し、時間がかかっても待つことで自信を育てる。'},
  ISTP:{name:'静かな探検タイプ', one:'無言で観察、納得したら即行動。', hint:'静かに観察してから動く。口出しを減らし、触って学べる道具を用意。手順は最小限にし、危険だけ明確に伝える。できた瞬間を逃さず称賛し、次の課題は本人の興味から選ぶ。'},
};


/* ========== アプリ本体 ========== */
const $ = sel => document.querySelector(sel);
const els = {
  top: $('#page-top'), quiz: $('#page-quiz'), result: $('#page-result'), all: $('#page-all'),
  startBtn: $('#startBtn'), resumeBtn: $('#resumeBtn'),
  backHomeBtn: $('#backHomeBtn'), retryBtn: $('#retryBtn'), seeAllBtn: $('#seeAllBtn'),
  qIndex: $('#qIndex'), badgeCat: $('#badgeCat'), badgeScene: $('#badgeScene'), badgeAge: $('#badgeAge'),
  qText: $('#qText'), btnA: $('#btnA'), btnB: $('#btnB'), backBtn: $('#backBtn'), skipBtn: $('#skipBtn'),
  bar: $('#bar'),
  type4: $('#type4'), scoreEI: $('#scoreEI'), scoreSN: $('#scoreSN'), scoreFT: $('#scoreFT'), scoreJP: $('#scoreJP'),
  typeName: $('#typeName'), typeOneLiner: $('#typeOneLiner'), typeHint: $('#typeHint'),
  typesGrid: $('#typesGrid'),
  tab02: $('#tab02'), tab35: $('#tab35'),
  ageBadge: $('#ageBadge'), ageLabelResult: $('#ageLabelResult'),
  typeImg: $('#typeImg'), hintBox: $('#hintBox'),
  btnShare: $('#btnShare'), btnCopy: $('#btnCopy'), btnSaveImg: $('#btnSaveImg'),
};
let AGE='02', QUESTIONS=QUESTIONS_02, TOTAL=QUESTIONS.length, idx=0;
let answers = Array(TOTAL).fill(null);
let scores = {E:0,I:0,S:0,N:0,F:0,T:0,J:0,P:0};

(function enhance(){
  // 4グループ（分析家/番人/外交官/探検家）
  const TYPE_GROUP = {
    INTJ:'analyst', INTP:'analyst', ENTJ:'analyst', ENTP:'analyst',          // NT
    ISTJ:'sentinel', ISFJ:'sentinel', ESTJ:'sentinel', ESFJ:'sentinel',      // SJ
    INFJ:'diplomat', INFP:'diplomat', ENFJ:'diplomat', ENFP:'diplomat',      // NF
    ISTP:'explorer', ISFP:'explorer', ESTP:'explorer', ESFP:'explorer',      // SP
  };

  function lockAnswerButtons(lock){ els.btnA.disabled = lock; els.btnB.disabled = lock; }

  function show(page){
    els.top.style.display   = (page==='top')   ? 'block':'none';
    els.quiz.style.display  = (page==='quiz')  ? 'block':'none';
    els.result.style.display= (page==='result')? 'block':'none';
    els.all.style.display   = (page==='all')   ? 'block':'none';
  }

  function applyTheme(cat){
    els.quiz.classList.remove('theme-ei','theme-sn','theme-ft','theme-jp');
    if(cat==='EI') els.quiz.classList.add('theme-ei');
    if(cat==='SN') els.quiz.classList.add('theme-sn');
    if(cat==='FT') els.quiz.classList.add('theme-ft');
    if(cat==='JP') els.quiz.classList.add('theme-jp');
  }

  function storageKey(){ return `mbti_obs_state_${AGE}`; }
  function saveState(){ localStorage.setItem(storageKey(), JSON.stringify({idx,answers,scores})); }
  function loadState(){
    const raw=localStorage.getItem(storageKey());
    if(!raw) return false;
    try{
      const s=JSON.parse(raw);
      idx=s.idx??0; answers=s.answers??answers; scores=s.scores??scores;
      return true;
    }catch(e){ return false; }
  }

  function renderQuestion(){
    const q=QUESTIONS[idx];
    els.qIndex.textContent = `質問 ${idx+1} / ${TOTAL}`;
    els.badgeCat.textContent = ({EI:'E / I',SN:'S / N',FT:'F / T',JP:'J / P'})[q.cat]||q.cat;
    els.badgeScene.textContent = `場面：${q.scene}`;
    els.qText.textContent = q.q;
    els.btnA.textContent = 'A　' + (q.A??'');
    els.btnB.textContent = 'B　' + (q.B??'');

    els.bar.style.width = Math.round(((idx+1)/TOTAL)*100) + '%';

    applyTheme(q.cat);
    saveState();
    lockAnswerButtons(false);
  }

  function applyScore(q,choice){
    const prev=answers[idx];
    if(prev==='A'){ scores[q.Ais]=Math.max(0, scores[q.Ais]-1); }
    if(prev==='B'){ scores[q.Bis]=Math.max(0, scores[q.Bis]-1); }
    answers[idx]=choice;
    if(choice==='A') scores[q.Ais]+=1;
    if(choice==='B') scores[q.Bis]+=1;
  }

  function next(){ if(idx<TOTAL-1){ idx++; renderQuestion(); } else { showResult(); } }
  function back(){ if(idx>0){ idx--; renderQuestion(); } }
  function skip(){ answers[idx]='-'; next(); }

// 結果
function showResult(){
  try{
    // ① スコア→各軸
    const EI = (scores.E >= scores.I) ? 'E' : 'I';
    const SN = (scores.S >= scores.N) ? 'S' : 'N';
    const FT = (scores.F >= scores.T) ? 'F' : 'T';
    const JP = (scores.J >= scores.P) ? 'J' : 'P';
    const type = EI + SN + FT + JP;

    // ② 結果カードのテーマ色（分析家/番人/外交官/探検家）
    {
      const pr = document.getElementById('page-result');
      if (pr) {
        // TYPE_GROUP は enhance() の冒頭で宣言済みのはず
        const group = (typeof TYPE_GROUP !== 'undefined' && TYPE_GROUP[type]) ? TYPE_GROUP[type] : '';
        pr.classList.remove('theme-analyst','theme-sentinel','theme-diplomat','theme-explorer');
        if (group) pr.classList.add(`theme-${group}`);
      }
    }

    // ③ スコア表示テキスト
    els.type4.textContent = type;
    els.scoreEI.textContent = `E ${scores.E} : I ${scores.I}`;
    els.scoreSN.textContent = `S ${scores.S} : N ${scores.N}`;
    els.scoreFT.textContent = `F ${scores.F} : T ${scores.T}`;
    els.scoreJP.textContent = `J ${scores.J} : P ${scores.P}`;

    // ④ タイプ名・一言・ヒント
    const t = TYPE_TEXT[type] || {name:'', one:'', hint:''};
    const cleanName = (t.name||'').trim();
    els.typeName.textContent     = cleanName ? `${cleanName}（${type}）` : `（${type}）`;
    els.typeOneLiner.textContent = t.one  || 'どちらの傾向もあります。発達の途中かも🌱';
    els.typeHint.textContent     = t.hint || '日々の観察を続け、安心のリズムと選択肢を用意してみましょう。';

    // ⑤ タイプ画像（存在すれば表示）
    (function loadTypeImage(){
      const imgEl  = els.typeImg;
      if(!imgEl) return;
      const base   = 'assets/types/';
      const prefix = (AGE === '35' ? '35' : '02');
      const candidates = [
        `${base}${prefix}${type}.png`,
        `${base}${prefix}${type}.jpg`,
        `${base}${prefix}${type}.webp`,
        `${base}${type}.png`,
        `${base}${type}.jpg`,
        `${base}${type}.webp`,
      ];
      let i = 0;
      const tryNext = () => {
        if (i >= candidates.length){ imgEl.style.display = 'none'; return; }
        const url = candidates[i] + `?v=${Date.now()}`;
        imgEl.onload  = () => { imgEl.style.display = 'block'; imgEl.onload = imgEl.onerror = null; };
        imgEl.onerror = () => { i++; tryNext(); };
        imgEl.src = url;
      };
      tryNext();
    })();

    // ⑥ 4軸バーの描画（左右に振り分け）
    (function updateAxes(){
      const set = (rowSel, leftCount, rightCount) => {
        const row = document.querySelector(rowSel);
        if(!row) return;
        const total = Math.max(1, leftCount + rightCount);
        const leftPct  = (leftCount  / total) * 50; // 左側最大50%
        const rightPct = (rightCount / total) * 50; // 右側最大50%
        row.querySelector('.axis-fillL').style.width = leftPct  + '%';
        row.querySelector('.axis-fillR').style.width = rightPct + '%';
      };
      set('.axis-EI', scores.E, scores.I);
      set('.axis-SN', scores.S, scores.N);
      set('.axis-FT', scores.F, scores.T);
      set('.axis-JP', scores.J, scores.P);
    })();

    // ⑦ 表示＆保存
    show('result');
    saveState();

  }catch(err){
    console.error('showResult failed:', err);
    try{ show('result'); }catch(_){}
  }
}


 
const AGE_KEY = 'mbti_obs_age';
  function setAge(age){
    AGE=age;
    localStorage.setItem(AGE_KEY, AGE);
    QUESTIONS=(AGE==='02')?QUESTIONS_02:QUESTIONS_35;
    TOTAL=QUESTIONS.length;
    els.tab02.classList.toggle('active', AGE==='02');
    els.tab35.classList.toggle('active', AGE!=='02');
    els.ageBadge.textContent       = `対象：${AGE==='02'?'0–2歳':'3–5歳'}`;
    els.badgeAge.textContent       = (AGE==='02'?'0–2歳':'3–5歳');
    els.ageLabelResult.textContent = (AGE==='02'?'0–2歳':'3–5歳');
    show('top');
    els.resumeBtn.classList.toggle('ghost', !localStorage.getItem(storageKey()));
  }

  function resetAll(){ idx=0; answers=Array(TOTAL).fill(null); scores={E:0,I:0,S:0,N:0,F:0,T:0,J:0,P:0}; saveState(); }
  function start(){ resetAll(); show('quiz'); renderQuestion(); }
  function resume(){ if(loadState()){ show('quiz'); renderQuestion(); } else { alert('前回の続きはありません。'); start(); }}

  // イベント
  els.btnA.addEventListener('click', ()=>{ lockAnswerButtons(true); const q=QUESTIONS[idx]; applyScore(q,'A'); setTimeout(next, 60); });
  els.btnB.addEventListener('click', ()=>{ lockAnswerButtons(true); const q=QUESTIONS[idx]; applyScore(q,'B'); setTimeout(next, 60); });
  els.backBtn.onclick = back;
  els.skipBtn.onclick = skip;
  els.seeAllBtn.onclick = ()=>{ renderAllTypes(); show('all'); };
  els.backHomeBtn.onclick = ()=>show('top');
  els.retryBtn.onclick = start;
  els.startBtn.onclick = start;
  els.resumeBtn.onclick = resume;
  els.tab02.onclick = ()=>setAge('02');
  els.tab35.onclick = ()=>setAge('35');

  // 初期化
  (function init(){
    const savedAge = localStorage.getItem(AGE_KEY);
    setAge(savedAge==='35' ? '35' : '02');
  })();

  // 共有
  async function doShare(){
    const text = [
      `観察型MBTI（${els.ageLabelResult.textContent}）の診断結果`,
      `タイプ：${els.type4.textContent} / ${els.typeName.textContent.replace(/（.*?）/,'')}`,
      `E/I: ${els.scoreEI.textContent}｜S/N: ${els.scoreSN.textContent}`,
      `F/T: ${els.scoreFT.textContent}｜J/P: ${els.scoreJP.textContent}`,
      `ひとこと：${els.typeOneLiner.textContent}`,
      `ヒント：${els.typeHint.textContent}`
    ].join('\n');

    if (navigator.share){
      try{ await navigator.share({title:'観察型MBTI 診断結果', text}); }catch(e){}
    }else{
      try{ await navigator.clipboard.writeText(text); alert('共有メニュー非対応のためテキストをコピーしました。'); }
      catch(e){ alert('コピーに失敗しました。手動でコピーしてください。'); }
    }
  }

  async function saveAsImage(){
    const w=1080,h=1350;
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d');

    const g=ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0,'#fff1e6'); g.addColorStop(1,'#e7f8ff');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

    ctx.fillStyle='#ffffff'; ctx.strokeStyle='#e6eef7';
    roundRect(ctx,60,80,w-120,h-160,36,true,true);

    ctx.fillStyle='#1f2a37'; ctx.font='bold 56px "Noto Sans JP", sans-serif';
    ctx.fillText('観察型MBTI 診断結果', 100, 170);

    ctx.fillStyle='#5b6472'; ctx.font='32px "Noto Sans JP", sans-serif';
    ctx.fillText(els.ageLabelResult.textContent, 100, 220);

    ctx.fillStyle='#1f2a37'; ctx.font='bold 120px "Noto Sans JP", sans-serif';
    ctx.fillText(els.type4.textContent, 100, 340);

    ctx.font='bold 44px "Noto Sans JP", sans-serif';
    const name = els.typeName.textContent.replace(/（.*?）/,'');
    ctx.fillText(name, 100, 410);
    ctx.font='32px "Noto Sans JP", sans-serif';
    wrapText(ctx, els.typeOneLiner.textContent, 100, 460, w-200, 40);

    ctx.font='bold 36px "Noto Sans JP", sans-serif';
    ctx.fillText(`E/I: ${els.scoreEI.textContent}`, 100, 600);
    ctx.fillText(`S/N: ${els.scoreSN.textContent}`, 100, 650);
    ctx.fillText(`F/T: ${els.scoreFT.textContent}`, 100, 700);
    ctx.fillText(`J/P: ${els.scoreJP.textContent}`, 100, 750);

    ctx.font='bold 36px "Noto Sans JP", sans-serif';
    ctx.fillText('関わりのヒント', 100, 830);
    ctx.font='30px "Noto Sans JP", sans-serif';
    wrapText(ctx, els.typeHint.textContent, 100, 880, w-200, 40);

    ctx.fillStyle='#5b6472'; ctx.font='26px "Noto Sans JP", sans-serif';
    ctx.fillText('© 観察型MBTI', 100, h-100);

    const a=document.createElement('a');
    a.download=`mbti_${els.type4.textContent}.png`;
    a.href=c.toDataURL('image/png');
    a.click();
  }

  function roundRect(ctx,x,y,w,h,r,fill,stroke){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill(); if(stroke){ ctx.lineWidth=2; ctx.stroke(); }
  }
  function wrapText(ctx,text,x,y,maxWidth,lineHeight){
    const chars = text.split('');
    let line = '';
    for(let i=0;i<chars.length;i++){
      const test=line+chars[i];
      if(ctx.measureText(test).width>maxWidth){
        ctx.fillText(line, x, y);
        line=chars[i];
        y+=lineHeight;
      }else{
        line=test;
      }
    }
    ctx.fillText(line, x, y);
  }

  els.btnShare.onclick = doShare;
  els.btnCopy.onclick = async ()=>{
    try{
      const text = [
        `観察型MBTI（${els.ageLabelResult.textContent}）の診断結果`,
        `タイプ：${els.type4.textContent} / ${els.typeName.textContent.replace(/（.*?）/,'')}`,
        `E/I: ${els.scoreEI.textContent}｜S/N: ${els.scoreSN.textContent}`,
        `F/T: ${els.scoreFT.textContent}｜J/P: ${els.scoreJP.textContent}`,
        `ひとこと：${els.typeOneLiner.textContent}`,
        `ヒント：${els.typeHint.textContent}`
      ].join('\n');
      await navigator.clipboard.writeText(text);
      alert('診断結果テキストをコピーしました。');
    }catch(e){ alert('コピーに失敗しました。手動で選択してコピーしてください。'); }
  };
  els.btnSaveImg.onclick = saveAsImage;

  // 公開用エクスポート（必要なら）
  window.start = start; window.resume = resume;
})();
</script>
</body>
</html>
